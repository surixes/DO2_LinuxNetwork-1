# Сети в Linux

## Part 1. Инструмент ipcalc

### 1.1. Сети и маски

1. Чтобы определить адрес сети `192.167.38.54/13` используем команду `ipcalc`:

| ![Скриншот с выводом адреса сети](./images/ipcalc.png "Адрес сети") |
| :-----------------------------------------------------------------: |
|                        _Рис. 1. Адрес сети_                         |

- Адрес сети: `192.167.38.54`

2. Перевод маски `255.255.255.0` в префиксную и двоичную запись:

| ![Скриншот с выводом перевода первой маски](./images/first-mask.png "Перевод маски") |
| :----------------------------------------------------------------------------------: |
|                _Рис. 2. Перевод маски в префиксную и двоичную запись_                |

- Префиксная запись: `24`
- Двоичная запись: `11111111.11111111.11111111.00000000`

Перевод маски `/15` в обычную и двоичную запись:

| ![Скриншот с выводом перевода второй маски](./images/second-mask.png "Перевод маски") |
| :-----------------------------------------------------------------------------------: |
|                  _Рис. 3. Перевод маски в обычную и двоичную запись_                  |

- Обычная запись: `255.254.0.0`
- Двоичная запись: `11111111.11111110.00000000.00000000`

Перевод маски `11111111.11111111.11111111.11110000` в обычную и префиксную запись:

| ![Скриншот с выводом перевода третьей маски](./images/third-mask.png "Перевод маски") |
| :-----------------------------------------------------------------------------------: |
|                 _Рис. 4. Перевод маски в обычную и префиксную запись_                 |

- Обычная запись: `255.255.255.0`
- Префиксная запись: `24`

3. Определение максимального и минимального хоста в сети `12.167.38.4` для маски `/8`:

| ![Скриншот с выводом хостов для первой маски](./images/first-minmaxhost.png "Максимальный и минимальный хост") |
| :------------------------------------------------------------------------------------------------------------: |
|                               _Рис. 5. Максимальный/Минимальный хост для маски_                                |

- HostMin: `12.0.0.1`
- HostMax: `12.255.255.254`

Определение максимального и минимального хоста в сети `12.167.38.4` для маски `11111111.11111111.00000000.00000000`:

| ![Скриншот с выводом хостов для второй маски](./images/second-minmaxhost.png "Максимальный и минимальный хост") |
| :-------------------------------------------------------------------------------------------------------------: |
|                                _Рис. 6. Максимальный/Минимальный хост для маски_                                |

- HostMin: `12.167.38.1`
- HostMax: `12.167.38.254`

Определение максимального и минимального хоста в сети `12.167.38.4` для маски `255.255.254.0`:

| ![Скриншот с выводом хостов для третьей маски](./images/third-minmaxhost.png "Максимальный и минимальный хост") |
| :-------------------------------------------------------------------------------------------------------------: |
|                                _Рис. 7. Максимальный/Минимальный хост для маски_                                |

- HostMin: `12.167.38.1`
- HostMax: `12.167.39.254`

Определение максимального и минимального хоста в сети `12.167.38.4` для маски `/4`:

| ![Скриншот с выводом хостов для четвертой маски](./images/fourth-minmaxhost.png "Максимальный и минимальный хост") |
| :----------------------------------------------------------------------------------------------------------------: |
|                                 _Рис. 8. Максимальный/Минимальный хост для маски_                                  |

- HostMin: `0.0.0.1`
- HostMax: `15.255.255.254`

---

### 1.2. localhost

Проверим `194.34.23.100` с помощью `ipcalc`:

| ![Скриншот с выводом информации о хосте](./images/first-localhost.png "Информация о хосте") |
| :-----------------------------------------------------------------------------------------: |
|                   _Рис. 9. Вывод информации о первом хосте (не подходит)_                   |

Проверим `127.0.0.2` с помощью `ipcalc`:

| ![Скриншот с выводом информации о хосте](./images/second-localhost.png "Информация о хосте") |
| :------------------------------------------------------------------------------------------: |
|                    _Рис. 10. Вывод информации о втором хосте (подходит)_                     |

Проверим `127.1.0.1` с помощью `ipcalc`:

| ![Скриншот с выводом информации о хосте](./images/third-localhost.png "Информация о хосте") |
| :-----------------------------------------------------------------------------------------: |
|                   _Рис. 11. Вывод информации о третьем хосте (подходит)_                    |

Проверим `128.0.0.1` с помощью `ipcalc`:

| ![Скриншот с выводом информации о хосте](./images/first-localhost.png "Информация о хосте") |
| :-----------------------------------------------------------------------------------------: |
|                 _Рис. 12. Вывод информации о четвертом хосте (не подходит)_                 |

---

### 1.3. Диапазоны и сегменты сетей

1. Публичные IP-адреса:

| ![Скриншот с выводом информации о хосте](./images/132.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                            _Рис. 13. Публичный хост_                            |

| ![Скриншот с выводом информации о хосте](./images/135.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                            _Рис. 14. Публичный хост_                            |

| ![Скриншот с выводом информации о хосте](./images/136.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                            _Рис. 15. Публичный хост_                            |

| ![Скриншот с выводом информации о хосте](./images/137.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                            _Рис. 16. Публичный хост_                            |

| ![Скриншот с выводом информации о хосте](./images/1310.png "Информация о хосте") |
| :------------------------------------------------------------------------------: |
|                            _Рис. 17. Публичный хост_                             |

Частные IP-адреса:

| ![Скриншот с выводом информации о хосте](./images/131.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                             _Рис. 18. Частный хост_                             |

| ![Скриншот с выводом информации о хосте](./images/133.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                             _Рис. 19. Частный хост_                             |

| ![Скриншот с выводом информации о хосте](./images/134.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                             _Рис. 20. Частный хост_                             |

| ![Скриншот с выводом информации о хосте](./images/138.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                             _Рис. 21. Частный хост_                             |

| ![Скриншот с выводом информации о хосте](./images/139.png "Информация о хосте") |
| :-----------------------------------------------------------------------------: |
|                             _Рис. 22. Частный хост_                             |

2. Учитывая значенич `HostMin` и `HostMax` для сети, доступны следующие IP адреса:

- `10.10.0.2`
- `10.10.10.10`
- `10.10.1.255`

| ![Скриншот с выводом информации о хосте](./images/mblocalhost.png "Информация о хосте") |
| :-------------------------------------------------------------------------------------: |
|              _Рис. 23. Информация Максимальный/Минимальный хост для сети_               |

## Part 2. Статическая маршрутизация между двумя машинами

| ![Скриншот с выводом информации о работе двух виртуальных машин](./images/ws12.png "Работа двух виртуальных машин") |
| :-----------------------------------------------------------------------------------------------------------------: |
|                                      _Рис. 24. Работа двух виртуальных машин_                                       |

Чтобы посмотреть существующие сетевые интерфейсы используем команду `ip a`:

| ![Скриншот с выводом сетевых интерфейсов](./images/ipa-ws1.png "Сетевые интерфейсы") |
| :----------------------------------------------------------------------------------: |
|                        _Рис. 25. Сетевые интерфейсы для ws1_                         |

| ![Скриншот с выводом сетевых интерфейсов](./images/ipa-ws2.png "Сетевые интерфейсы") |
| :----------------------------------------------------------------------------------: |
|                        _Рис. 26. Сетевые интерфейсы для ws2_                         |

---

Чтобы задать нужные адреса и маски для каждой из машин, воспользуемся командой: `sudo nano ../../etc/netplan/00-installer-config.yaml`

| ![Скриншот с выводом содержания измененного файла ws1](./images/updateIP-ws1.png "ws1") |
| :-------------------------------------------------------------------------------------: |
|                             _Рис. 27. Измененный файл ws1_                              |

| ![Скриншот с выводом содержания измененного файла ws2](./images/updateIP-ws2.png "ws2") |
| :-------------------------------------------------------------------------------------: |
|                             _Рис. 28. Измененный файл ws2_                              |

---

| ![Скриншот с выводом успешного применения изменений ws1](./images/neplan-apply-ws1.png "ws1") |
| :-------------------------------------------------------------------------------------------: |
|                              _Рис. 29. Применение изменений ws1_                              |

| ![Скриншот с выводом успешного применения изменений ws2](./images/netplan-apply-ws2.png "ws2") |
| :--------------------------------------------------------------------------------------------: |
|                              _Рис. 30. Применение изменений ws2_                               |

---

### 2.1. Добавление статического маршрута вручную

| ![Скриншот с добавление статического маршрута от ws1 к ws2](./images/ipradd-ws1.png "Статический маршрут ws1") |
| :------------------------------------------------------------------------------------------------------------: |
|                                  _Рис. 31. Добавление статического маршрута_                                   |

| ![Скриншот с добавление статического маршрута от ws2 к ws1](./images/ipradd-ws2.png "Статический маршрут ws2") |
| :------------------------------------------------------------------------------------------------------------: |
|                                  _Рис. 32. Добавление статического маршрута_                                   |

Пропингуем связь между машинами, чтобы проверить корректность добавления статического маршрута:

| ![Скриншот с выводом ping](./images/ping-ws1.png "ping ws1") |
| :----------------------------------------------------------: |
|      _Рис. 33. Проверка соединения с помощью ping(ws1)_      |

| ![Скриншот с выводом ping](./images/ping-ws2.png "ping ws2") |
| :----------------------------------------------------------: |
|      _Рис. 34. Проверка соединения с помощью ping(ws2)_      |

---

### 2.2. Добавление статического маршрута с сохранением

Добавим статический маршрут от одной машины к другой с помощью файла `/etc/netplan/00-installer-config.yaml`:

| ![Скриншот с добавление статического маршрута от ws1 к ws2 с сохранением](./images/static-route-ws1.png "Статический маршрут ws1") |
| :--------------------------------------------------------------------------------------------------------------------------------: |
|                                   _Рис. 35. Добавление статического маршрута с сохранением ws1_                                    |

| ![Скриншот с добавление статического маршрута от ws2 к ws1 с сохранением](./images/static-route-ws2.png "Статический маршрут ws2") |
| :--------------------------------------------------------------------------------------------------------------------------------: |
|                                   _Рис. 36. Добавление статического маршрута с сохранением ws2_                                    |

Пропингуем соединение между машинами:

| ![Скриншот с выводом ping с сохранением статического маршрута ws1](./images/ping-ws11.png "ping ws1") |
| :---------------------------------------------------------------------------------------------------: |
|                          _Рис. 37. Проверка соединения с помощью ping(ws1)_                           |

| ![Скриншот с выводом ping с сохранением статического маршрута ws2](./images/ping-ws21.png "ping ws2") |
| :---------------------------------------------------------------------------------------------------: |
|                          _Рис. 38. Проверка соединения с помощью ping(ws2)_                           |

---

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

8 Mbps = 1 MB/s
100 MB/s = 819200 Kbps
1 Gbps = 1024 Mbps

---

### 3.2. Утилита iperf3

Назначим в качестве клиента `ws1`:

| ![Скриншот с выводом утилиты iperf3 для ws1](./images/client-ws1.png "iperf3 ws1") |
| :--------------------------------------------------------------------------------: |
|                               _Рис. 39. iperf3 ws1_                                |

А `ws2` назначим в качестве севера:

| ![Скриншот с выводом утилиты iperf3 для ws2](./images/server-ws2.png "iperf3 ws2") |
| :--------------------------------------------------------------------------------: |
|                               _Рис. 40. iperf3 ws2_                                |

---

## Part 4. Сетевой экран

### 4.1. Утилита iptables

| ![Скриншот с выводом содержания файла firewall.sh для ws1](./images/iptables-ws1.png "iptables ws1") |
| :--------------------------------------------------------------------------------------------------: |
|                                       _Рис. 41. iptables ws1_                                        |

| ![Скриншот с выводом содержания файла firewall.sh для ws2](./images/iptables-ws2.png "iptables ws2") |
| :--------------------------------------------------------------------------------------------------: |
|                                       _Рис. 42. iptables ws2_                                        |

Чтобы запустить файлы на обеих машинах воспользуемся командами `sudo chmod +x /ect/firewall.sh` и `sudo /etc/firewall.sh`:

| ![Скриншот с выводом команд для запуска скрипта](./images/start-firewall.png "start") |
| :-----------------------------------------------------------------------------------: |
|                               _Рис. 43. start firewall_                               |

- Разница между стратегиями заключается в том, что в первом файле первым подходящим правилом для пакета является запрет, а во втором - разрешение. Применяется только первое подходящее правило, остальные игнорируются.

---

### 4.2. Утилита nmap

- `ping` с `ws1` на `ws2`:

| ![Скриншот с выводом ping ws1](./images/firewall-ping-ws1.png "ping for ws1") |
| :---------------------------------------------------------------------------: |
|                            _Рис. 44. nmap для ws2_                            |

- `ping` с `ws2` на `ws1`:

| ![Скриншот с выводом ping ws2](./images/firewall-ping-ws2.png "ping for ws2") |
| :---------------------------------------------------------------------------: |
|                            _Рис. 45. nmap для ws2_                            |

- `nmap` для `ws2`:

| ![Скриншот с выводом утилиты nmap для ws2](./images/nmap-ws2.png "nmap") |
| :----------------------------------------------------------------------: |
|                         _Рис. 46. nmap для ws2_                          |

---

## Part 5. Статическая маршрутизация сети

### 5.1. Настройка адресов машин

- `ws11`:

| ![Скриншот с конфигурацией ws11](./images/installer-config-ws11.png "ws11") |
| :-------------------------------------------------------------------------: |
|                    _Рис. 47. installer-config для ws11_                     |

- `ws21`:

| ![Скриншот с конфигурацией ws21](./images/installer-config-ws21.png "ws21") |
| :-------------------------------------------------------------------------: |
|                    _Рис. 48. installer-config для ws21_                     |

- `ws22`:

| ![Скриншот с конфигурацией ws22](./images/installer-config-ws22.png "ws22") |
| :-------------------------------------------------------------------------: |
|                    _Рис. 49. installer-config для ws22_                     |

- `r1`:

| ![Скриншот с конфигурацией r1](./images/installer-config-r1.png "r1") |
| :-------------------------------------------------------------------: |
|                  _Рис. 50. installer-config для r1_                   |

- `r2`:

| ![Скриншот с конфигурацией r2](./images/installer-config-r2.png "r2") |
| :-------------------------------------------------------------------: |
|                  _Рис. 51. installer-config для r2_                   |

Для всех машин выполнил команду `sudo netplan apply` для перезапуска сервиса сети.

- `ws11`:

| ![Скриншот с выводом команды для проверки адреса ws11](./images/ip-a-ws11.png "ws11") |
| :-----------------------------------------------------------------------------------: |
|                     _Рис. 52. результат команды ip -4 a для ws11_                     |

- `ws21`:

| ![Скриншот с выводом команды для проверки адреса ws21](./images/ip-a-ws21.png "ws21") |
| :-----------------------------------------------------------------------------------: |
|                     _Рис. 53. результат команды ip -4 a для ws21_                     |

- `ws22`:

| ![Скриншот с выводом команды для проверки адреса ws22](./images/ip-a-ws22.png "ws22") |
| :-----------------------------------------------------------------------------------: |
|                     _Рис. 54. результат команды ip -4 a для ws22_                     |

- `r1`:

| ![Скриншот с выводом команды для проверки адреса r1](./images/ip-a-r1.png "r1") |
| :-----------------------------------------------------------------------------: |
|                   _Рис. 55. результат команды ip -4 a для r1_                   |

- `r2`:

| ![Скриншот с выводом команды для проверки адреса r2](./images/ip-a-r2.png "r2") |
| :-----------------------------------------------------------------------------: |
|                   _Рис. 56. результат команды ip -4 a для r2_                   |

Пропингуем ws22 c ws21: `ping -c 5 10.20.0.20`

| ![Скриншот с выводом успешного пинга ws22 с ws21](./images/ping-ws21-ws22.png "ws22 c ws21") |
| :------------------------------------------------------------------------------------------: |
|                                 _Рис. 57. Пинг ws22 c ws21_                                  |

Пропингуем r1 c ws11: `ping -c 5 10.10.0.2`

| ![Скриншот с выводом успешного пинга r1 с ws11](./images/ping-ws11-r1.png "r1 c ws11") |
| :------------------------------------------------------------------------------------: |
|                               _Рис. 58. Пинг r1 c ws11_                                |

---

### 5.2. Включение переадресации IP-адресов

Для включения переадресации IP на роутерах `r1` и `r2` выполним команду `sudo sysctl -w net.ipv4.ip_forward=1`:

| ![Скриншот с выводом команды для переадресации IP r1](./images/redirection-r1.png "переадресация r1") |
| :---------------------------------------------------------------------------------------------------: |
|                         _Рис. 59. Команда для включения переадресации для r1_                         |

| ![Скриншот с выводом команды для переадресации IP r2](./images/redirection-r2.png "переадресация r2") |
| :---------------------------------------------------------------------------------------------------: |
|                         _Рис. 60. Команда для включения переадресации для r2_                         |

Для включения переадресации на постоянной основе используем команду `sudo nano /etc/sysctl.conf` и добавим строку `net.ipv4.ip_forward=1`.

| ![Скриншот с выводом файл sysctl.conf r1](./images/sysctl-r1.png "r1") |
| :--------------------------------------------------------------------: |
|               _Рис. 61. Содержание файла sysctl.conf r1_               |

| ![Скриншот с выводом файл sysctl.conf r2](./images/sysctl-r2.png "r2") |
| :--------------------------------------------------------------------: |
|               _Рис. 62. Содержание файла sysctl.conf r2_               |

---

### 5.3. Установка маршрута по умолчанию

Настроим маршрут по умолчанию (шлюз) для рабочих станций. Для этого добавим `default` перед IP-роутера в файле конфигураций.

| ![Скриншот с выводом файл netplan-config ws11](./images/default-ws11.png "ws11") |
| :------------------------------------------------------------------------------: |
|                 _Рис. 63. Содержание файла netplan-config ws11_                  |

| ![Скриншот с выводом файл netplan-config ws21](./images/default-ws21.png "ws21") |
| :------------------------------------------------------------------------------: |
|                 _Рис. 64. Содержание файла netplan-config ws21_                  |

| ![Скриншот с выводом файл netplan-config ws22](./images/default-ws22.png "ws22") |
| :------------------------------------------------------------------------------: |
|                 _Рис. 65. Содержание файла netplan-config ws22_                  |

Чтобы проверить добавился ли маршрут в таблицу маршрутизации, используем команду `ip r`:

| ![Скриншот с выводом команды ip r ws11](./images/ip-r-ws11.png "ws11") |
| :--------------------------------------------------------------------: |
|                   _Рис. 66. Вывод команды ip r ws11_                   |

| ![Скриншот с выводом команды ip r ws21](./images/ip-r-ws21.png "ws21") |
| :--------------------------------------------------------------------: |
|                   _Рис. 67. Вывод команды ip r ws21_                   |

| ![Скриншот с выводом команды ip r ws22](./images/ip-r-ws22.png "ws22") |
| :--------------------------------------------------------------------: |
|                   _Рис. 68. Вывод команды ip r ws22_                   |

Пропингуем роутер `r2` с `ws11`:

| ![Скриншот с выводом команды tcpdump r2](./images/tcpdump-r2.png "r2") |
| :--------------------------------------------------------------------: |
|                  _Рис. 69. Вывод команды tcpdump r2_                   |

| ![Скриншот с выводом команды ping ws11](./images/ping-ws11-r2.png "ws22") |
| :-----------------------------------------------------------------------: |
|                    _Рис. 70. Вывод команды ping ws11_                     |

---

### 5.4. Добавление статических маршрутов

| ![Скриншот с выводом файла installer config r1](./images/config-r1.png "r1") |
| :--------------------------------------------------------------------------: |
|                  _Рис. 71. Вывод файла installer-config r1_                  |

| ![Скриншот с выводом файла installer config r2](./images/config-r2.png "r2") |
| :--------------------------------------------------------------------------: |
|                  _Рис. 72. Вывод файла installer-config r2_                  |

Вызовем `ip r` на каждом из роутеров:

| ![Скриншот с выводом команды ip r r1](./images/ip-r-r1.png "r1") |
| :--------------------------------------------------------------: |
|                 _Рис. 73. Вывод команды ip r r1_                 |

| ![Скриншот с выводом команды ip r r1](./images/ip-r-r1.png "r2") |
| :--------------------------------------------------------------: |
|                 _Рис. 74. Вывод команды ip r r2_                 |

Запустим команды `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`

| ![Скриншот с выводом команды ip r list ws11](./images/r-list-w11.png "ws11") |
| :--------------------------------------------------------------------------: |
|                   _Рис. 75. Вывод команды ip r list ws11_                    |

Когда устройство определяет, как направить пакет данных, оно руководствуется таблицей маршрутизации. Приоритет отдается наиболее специфичному маршруту, то есть маршруту с наибольшей длиной маски подсети.

---

### 5.5. Построение списка маршрутизаторов

Запустим на `r1` команду дампа:

| ![Скриншот с выводом команды tcpdump r1](./images/tcpdump-r1.png "r1") |
| :--------------------------------------------------------------------: |
|                  _Рис. 76. Вывод команды tcpdump r1_                   |

При помощи утилиты traceroute построим список маршрутизаторов на пути от `ws11` до `ws21`:

| ![Скриншот с выводом команды traceroute ws11](./images/traceroute-ws11.png "ws11") |
| :--------------------------------------------------------------------------------: |
|                      _Рис. 77. Вывод команды traceroute ws11_                      |

> Traceroute определяет путь до целевого узла, отправляя UDP-пакеты с последовательно увеличивающимся TTL. Каждый маршрутизатор на пути уменьшает TTL на 1. Когда TTL достигает 0, маршрутизатор отправляет ICMP-сообщение «Time Exceeded», раскрывая свой адрес. В данном случае целевой узел (10.20.0.10) отвечает ICMP «Port Unreachable» на недоступные UDP-порты, что указывает на достижение конечной точки. Таким образом, анализируя ICMP-ответы от промежуточных узлов и цели, traceroute строит маршрут, фиксируя IP-адреса и время отклика каждого хопа. ARP-запросы в дампе отражают разрешение MAC-адресов для коммуникации между узлами.

---

### 5.6. Использование протокола ICMP при маршрутизации

Запустим на `r1` перехват сетевого трафика, проходящего через `enp0s8` с помощью команды: `tcpdump -n -i enp0s8 icmp`

| ![Скриншот с выводом команды tcpdump r1 для несуществующего ip](./images/tcpdump-r1-2.png "r1") |
| :---------------------------------------------------------------------------------------------: |
|                   _Рис. 78. Вывод команды tcpdump r1 для несуществующего ip_                    |

Пропингуем с `ws11` несуществующий IP `10.30.0.111` с помощью команды: `ping -c 1 10.30.0.111`

| ![Скриншот с выводом пинга несуществующего ip с ws11](./images/ping-ws11-2.png "ws11") |
| :------------------------------------------------------------------------------------: |
|                       _Рис. 79. Пинг несуществующего ip с ws11_                        |

---

## Part 6. Динамическая настройка IP с помощью DHCP

Для `r2` настроим в файле `/etc/dhcp/dhcpd.conf` конфигурацию службы `DHCP`:

| ![Скриншот с выводом содержания файла dhcpd.conf r2](./images/dhcpd-r2.png "r2") |
| :------------------------------------------------------------------------------: |
|                    _Рис. 80. Содержание файла dhcpd.conf r2_                     |

В файле `resolv.conf` пропишем `nameserver 8.8.8.8`:

| ![Скриншот с выводом содержания файла resolv.conf r2](./images/resolv-r2.png "r2") |
| :--------------------------------------------------------------------------------: |
|                     _Рис. 81. Содержание файла resolv.conf r2_                     |

Через `ip a` покажем, что `ws21` получила адрес:

| ![Скриншот с выводом команды ip a ws21](./images/ip-a-ws21-2.png "ws21") |
| :----------------------------------------------------------------------: |
|                        _Рис. 82. Вывод ip a ws21_                        |

ping `ws22` c `ws21`:

| ![Скриншот ping ws22 c ws21](./images/ping-ws21-ws22-2.png "ws21") |
| :----------------------------------------------------------------: |
|                    _Рис. 83. ping ws22 с ws21_                     |

Укажем MAC-адрес у `ws11`, для этого в `etc/netplan/00-installer-config.yaml` надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`:

| ![Скриншот вывода файла netplan-config ws11](./images/netplan-ws11.png "ws11") |
| :----------------------------------------------------------------------------: |
|               _Рис. 84. Содержимое файла installer-config ws11_                |

Внесем изменения в файл `/etc/dhcp/dhcpd.conf`:

| ![Скриншот с выводом содержания файла dhcpd.conf r1](./images/dhcpd-r1.png "r1") |
| :------------------------------------------------------------------------------: |
|                    _Рис. 85. Содержание файла dhcpd.conf r1_                     |

В файле `resolv.conf` пропишем `nameserver 8.8.8.8`:

| ![Скриншот с выводом содержания файла resolv.conf r1](./images/resolv-r1.png "r1") |
| :--------------------------------------------------------------------------------: |
|                     _Рис. 86. Содержание файла resolv.conf r1_                     |

Через `ip a` покажем, что `ws11` получила адрес:

| ![Скриншот с выводом команды ip a ws11](./images/ip-a-ws11-2.png "ws11") |
| :----------------------------------------------------------------------: |
|                        _Рис. 87. Вывод ip a ws11_                        |

ping `ws22` c `ws21`:

| ![Скриншот ping ws22 c ws21](./images/ping-ws21-ws22-3.png "ws21") |
| :----------------------------------------------------------------: |
|                    _Рис. 88. ping ws22 с ws21_                     |

Проверяем IP до обновления на `ws21`:

| ![Скриншот с выводом команды ip a ws21](./images/ip-a-ws21-3.png "ws21") |
| :----------------------------------------------------------------------: |
|                        _Рис. 89. Вывод ip a ws21_                        |

Запросим с `ws21` обновление ip адреса с помощью команды `sudo dhclient -v`:

| ![Скриншот с выводом команды ip a ws21](./images/dhclient-ws21.png "ws21") |
| :------------------------------------------------------------------------: |
|                         _Рис. 90. Вывод ip a ws21_                         |

Проверяем IP после обновления на `ws21`:

| ![Скриншот с выводом команды ip a ws21](./images/ip-a-ws21-4.png "ws21") |
| :----------------------------------------------------------------------: |
|                        _Рис. 91. Вывод ip a ws21_                        |

В данном пункте использовались следующие DHCP опции:

- option routers - адрес шлюзов для клиентской сети. Маршрутизаторы должны быт перечислены в порядке предпочтительности.
- option domain-name-servers - Список DNS серверов доступны клиенту. Сервера должны быть перечислены в порядок предпочтительности.

---

## Part 7. NAT

В файле `/etc/apache2/ports.conf` на `ws22` и `r1` изменим строку `Listen 80` на `Listen 0.0.0.0:80`:

| ![Скриншот с содержимым ports.conf ws22](./images/ports-ws22.png "ws22") |
| :----------------------------------------------------------------------: |
|                     _Рис. 92. Файл ports.conf ws22_                      |

| ![Скриншот с содержимым ports.conf r1](./images/ports-r1.png "r1") |
| :----------------------------------------------------------------: |
|                   _Рис. 93. Файл ports.conf r1_                    |

Запустим веб-сервер Apache командой `service apache2 start` на `ws22` и `r1`:

| ![Скриншот с выводом команды запуска веб-сервера ws22](./images/apache2-ws22.png "ws22") |
| :--------------------------------------------------------------------------------------: |
|                            _Рис. 94. Запуск веб-сервера ws22_                            |

| ![Скриншот с выводом команды запуска веб-сервера r1](./images/apache2-r1.png "r1") |
| :--------------------------------------------------------------------------------: |
|                          _Рис. 95. Запуск веб-сервера r1_                          |

Добавим в фаервол, созданный по аналогии с фаерволом из Части 4, на `r2` следующие правила:

1. Удаление правил в таблице `filter — iptables -F`;

2. Удаление правил в таблице «NAT» — `iptables -F -t nat`;

3. Отбрасывать все маршрутизируемые пакеты — `iptables --policy FORWARD DROP`.

| ![Скриншот с содержанием файла firewall r2](./images/firewall-r2.png "r2") |
| :------------------------------------------------------------------------: |
|                 _Рис. 96. Содержимое файла firewall.sh r2_                 |

Запустим файл также, как в Части 4:

| ![Скриншот с запуском firewall r2](./images/firewall-r2-2.png "r2") |
| :-----------------------------------------------------------------: |
|                  _Рис. 97. Запуск firewall.sh r2_                   |

Проверим соединение между `ws22` и `r1` командой `ping`:

| ![Скриншот результата пинга ws22 с r1](./images/ping-r1-ws22.png "r1") |
| :--------------------------------------------------------------------: |
|                       _Рис. 98. Пинг ws22 с r1_                        |

Добавим в файл `/etc/firewall.sh` ещё одно правило:

4. Разрешить маршрутизацию всех пакетов протокола ICMP

| ![Скриншот с содержанием файла firewall r2](./images/firewall-r2-3.png "r2") |
| :--------------------------------------------------------------------------: |
|                  _Рис. 99. Содержимое файла firewall.sh r2_                  |

Запустим файл также, как в Части 4:

| ![Скриншот с запуском firewall r2](./images/firewall-r2-2.png "r2") |
| :-----------------------------------------------------------------: |
|                  _Рис. 100. Запуск firewall.sh r2_                  |

Проверим соединение между `ws22` и `r1` командой `ping`:

| ![Скриншот результата пинга ws22 с r1](./images/ping-r1-ws22-2.png "r1") |
| :----------------------------------------------------------------------: |
|                        _Рис. 101. Пинг ws22 с r1_                        |

Добавим в файл ещё два правила:

5. Включи `SNAT`, а именно маскирование всех локальных IP из локальной сети, находящейся за `r2`.

6. Включи `DNAT` на `8080` порт машины `r2` и добавить к веб-серверу Apache, запущенному на `ws22`, доступ извне сети.

| ![Скриншот с содержанием файла firewall r2](./images/firewall-r2-4.png "r2") |
| :--------------------------------------------------------------------------: |
|                 _Рис. 102. Содержимое файла firewall.sh r2_                  |

Проверь соединение по TCP для SNAT: для этого с `ws22` подключиться к серверу Apache на `r1` командой: `telnet [адрес] [порт]`

| ![Скриншот с успешным подключением ws22 к r1](./images/telnet-ws22-r1.png "ws22") |
| :-------------------------------------------------------------------------------: |
|                     _Рис. 103. Подключение к серверу с ws22_                      |

Проверим соединение по TCP для DNAT: для этого с `r1` подключиться к серверу Apache на `ws22` командой `telnet` (обратимся по адресу `r2` и порту `8080`):

| ![Скриншот с успешным подключением r1 к ws22](./images/telnet-r1-ws22.png "r1") |
| :-----------------------------------------------------------------------------: |
|                     _Рис. 104. Подключение к серверу с r1_                      |

---

## Part 8. Дополнительно. Знакомство с SSH Tunnels

Запустим на r2 фаервол с правилами из Части 7:

| ![Скриншот с содержанием файла firewall r2](./images/firewall-r2-4.png "r2") |
| :--------------------------------------------------------------------------: |
|                 _Рис. 105. Содержимое файла firewall.sh r2_                  |

Запустим веб-сервер Apache на `ws22` только на `localhost`:

| ![Скриншот с содержимым ports.conf ws22](./images/ports-ws22-2.png "ws22") |
| :------------------------------------------------------------------------: |
|                      _Рис. 106. Файл ports.conf ws22_                      |

| ![Скриншот с выводом команды запуска веб-сервера ws22](./images/start-server-ws22.png "ws22") |
| :-------------------------------------------------------------------------------------------: |
|                              _Рис. 107. Запуск веб-сервера ws22_                              |

Воспользуемся Local TCP forwarding с `ws21` до `ws22`, чтобы получить доступ к веб-серверу на `ws22` с `ws21` с помощью команды `ssh -L 8080:localhost:80 10.20.0.20`:

| ![Скриншот с выводом успешного подключения ws11 к ws22 по ssh](./images/tcp-forwarding-ws21-ws22.png "ws21") |
| :----------------------------------------------------------------------------------------------------------: |
|                                 _Рис. 108. Local TCP forwarding ws21 к ws22_                                 |

| ![Скриншот с проверкой подключения ws21](./images/telnet-ws21.png "ws21") |
| :-----------------------------------------------------------------------: |
|                   _Рис. 109. Проверка подключения ws21_                   |

Воспользуемся Remote TCP forwarding c `ws11` до `ws22`, чтобы получить доступ к веб-серверу на `ws22` с `ws11` с помощью команды `ssh -R 8080:localhost:80 10.20.0.20`:

| ![Скриншот с выводом успешного подключения ws21 к ws22 по ssh](./images/remote-tcp-forwaeding-ws21-ws22.png "ws21") |
| :-----------------------------------------------------------------------------------------------------------------: |
|                                    _Рис. 110. Remote TCP forwarding ws21 к ws22_                                    |

| ![Скриншот с проверкой подключения ws21](./images/telnet-ws21.png "ws21") |
| :-----------------------------------------------------------------------: |
|                   _Рис. 111. Проверка подключения ws21_                   |
